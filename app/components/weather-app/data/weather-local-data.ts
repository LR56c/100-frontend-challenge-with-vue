import type { WeatherRepository } from '~/components/weather-app/data/weather-repository'
import {
	WeatherResponseSchema
} from '~/components/weather-app/data/weather-forecast-data'
import type {
	Weather,
	WeatherForecast
} from '~/components/weather-app/weather'
import {
	weatherDescriptionParser,
	weatherIconParser
} from '~/lib/weather-icon-parser'


export class WeatherLocalData implements WeatherRepository {
	async getWeatherForecast( lat: number,
		lon: number ): Promise<Weather> {
		const json = {
			'city_name'   : 'Cartagena',
			'country_code': 'CL',
			'data'        : [
				{
					'app_max_temp'       : 17.9,
					'app_min_temp'       : 9.8,
					'clouds'             : 24,
					'clouds_hi'          : 0,
					'clouds_low'         : 34,
					'clouds_mid'         : 0,
					'datetime'           : '2024-11-13',
					'dewpt'              : 9.9,
					'high_temp'          : 17.9,
					'low_temp'           : 10.1,
					'max_dhi'            : null,
					'max_temp'           : 17.9,
					'min_temp'           : 9.8,
					'moon_phase'         : 0.97,
					'moon_phase_lunation': 0.42,
					'moonrise_ts'        : 1731531979,
					'moonset_ts'         : 1731486332,
					'ozone'              : 299,
					'pop'                : 0,
					'precip'             : 0,
					'pres'               : 988,
					'rh'                 : 77,
					'slp'                : 1014,
					'snow'               : 0,
					'snow_depth'         : 0,
					'sunrise_ts'         : 1731490656,
					'sunset_ts'          : 1731540269,
					'temp'               : 13.9,
					'ts'                 : 1731466860,
					'uv'                 : 11,
					'valid_date'         : '2024-11-13',
					'vis'                : 24,
					'weather'            : {
						'code'       : 802,
						'icon'       : 'c02d',
						'description': 'Scattered clouds'
					},
					'wind_cdir'          : 'WNW',
					'wind_cdir_full'     : 'west-northwest',
					'wind_dir'           : 283,
					'wind_gust_spd'      : 6.5,
					'wind_spd'           : 2.9
				},
				{
					'app_max_temp'       : 17.3,
					'app_min_temp'       : 10.1,
					'clouds'             : 80,
					'clouds_hi'          : 19,
					'clouds_low'         : 84,
					'clouds_mid'         : 0,
					'datetime'           : '2024-11-14',
					'dewpt'              : 10.7,
					'high_temp'          : 17.3,
					'low_temp'           : 12,
					'max_dhi'            : null,
					'max_temp'           : 17.3,
					'min_temp'           : 10.1,
					'moon_phase'         : 1,
					'moon_phase_lunation': 0.45,
					'moonrise_ts'        : 1731622773,
					'moonset_ts'         : 1731575008,
					'ozone'              : 304,
					'pop'                : 0,
					'precip'             : 0,
					'pres'               : 990,
					'rh'                 : 86,
					'slp'                : 1016,
					'snow'               : 0,
					'snow_depth'         : 0,
					'sunrise_ts'         : 1731577019,
					'sunset_ts'          : 1731626724,
					'temp'               : 13.1,
					'ts'                 : 1731553260,
					'uv'                 : 7,
					'valid_date'         : '2024-11-14',
					'vis'                : 24,
					'weather'            : {
						'code'       : 804,
						'icon'       : 'c04d',
						'description': 'Overcast clouds'
					},
					'wind_cdir'          : 'W',
					'wind_cdir_full'     : 'west',
					'wind_dir'           : 271,
					'wind_gust_spd'      : 5.4,
					'wind_spd'           : 2.4
				},
				{
					'app_max_temp'       : 19.6,
					'app_min_temp'       : 11.5,
					'clouds'             : 60,
					'clouds_hi'          : 0,
					'clouds_low'         : 71,
					'clouds_mid'         : 0,
					'datetime'           : '2024-11-15',
					'dewpt'              : 11.7,
					'high_temp'          : 19.9,
					'low_temp'           : 9.1,
					'max_dhi'            : null,
					'max_temp'           : 19.9,
					'min_temp'           : 11.5,
					'moon_phase'         : 0.99,
					'moon_phase_lunation': 0.49,
					'moonrise_ts'        : 1731713680,
					'moonset_ts'         : 1731664074,
					'ozone'              : 296,
					'pop'                : 0,
					'precip'             : 0,
					'pres'               : 990,
					'rh'                 : 83,
					'slp'                : 1016,
					'snow'               : 0,
					'snow_depth'         : 0,
					'sunrise_ts'         : 1731663385,
					'sunset_ts'          : 1731713179,
					'temp'               : 14.8,
					'ts'                 : 1731639660,
					'uv'                 : 10,
					'valid_date'         : '2024-11-15',
					'vis'                : 24,
					'weather'            : {
						'code'       : 803,
						'icon'       : 'c03d',
						'description': 'Broken clouds'
					},
					'wind_cdir'          : 'WSW',
					'wind_cdir_full'     : 'west-southwest',
					'wind_dir'           : 255,
					'wind_gust_spd'      : 4.5,
					'wind_spd'           : 2
				},
				{
					'app_max_temp'       : 18.9,
					'app_min_temp'       : 9.1,
					'clouds'             : 49,
					'clouds_hi'          : 64,
					'clouds_low'         : 32,
					'clouds_mid'         : 37,
					'datetime'           : '2024-11-16',
					'dewpt'              : 9.5,
					'high_temp'          : 19.2,
					'low_temp'           : 8,
					'max_dhi'            : null,
					'max_temp'           : 19.2,
					'min_temp'           : 9.1,
					'moon_phase'         : 0.96,
					'moon_phase_lunation': 0.52,
					'moonrise_ts'        : 1731800080,
					'moonset_ts'         : 1731753610,
					'ozone'              : 298,
					'pop'                : 55,
					'precip'             : 2.6560059,
					'pres'               : 991,
					'rh'                 : 79,
					'slp'                : 1017,
					'snow'               : 0,
					'snow_depth'         : 0,
					'sunrise_ts'         : 1731749751,
					'sunset_ts'          : 1731799634,
					'temp'               : 13.5,
					'ts'                 : 1731726060,
					'uv'                 : 8,
					'valid_date'         : '2024-11-16',
					'vis'                : 24,
					'weather'            : {
						'code'       : 520,
						'icon'       : 'r04d',
						'description': 'Light shower rain'
					},
					'wind_cdir'          : 'W',
					'wind_cdir_full'     : 'west',
					'wind_dir'           : 273,
					'wind_gust_spd'      : 5.9,
					'wind_spd'           : 2.5
				},
				{
					'app_max_temp'       : 23.3,
					'app_min_temp'       : 8,
					'clouds'             : 0,
					'clouds_hi'          : 0,
					'clouds_low'         : 4,
					'clouds_mid'         : 0,
					'datetime'           : '2024-11-17',
					'dewpt'              : 6.4,
					'high_temp'          : 24.1,
					'low_temp'           : 9,
					'max_dhi'            : null,
					'max_temp'           : 24.1,
					'min_temp'           : 8,
					'moon_phase'         : 0.91,
					'moon_phase_lunation': 0.55,
					'moonrise_ts'        : 1731890943,
					'moonset_ts'         : 1731843595,
					'ozone'              : 300,
					'pop'                : 20,
					'precip'             : 0.04686737,
					'pres'               : 992,
					'rh'                 : 59,
					'slp'                : 1018,
					'snow'               : 0,
					'snow_depth'         : 0,
					'sunrise_ts'         : 1731836120,
					'sunset_ts'          : 1731886089,
					'temp'               : 15.3,
					'ts'                 : 1731812460,
					'uv'                 : 11,
					'valid_date'         : '2024-11-17',
					'vis'                : 24,
					'weather'            : {
						'code'       : 800,
						'icon'       : 'c01d',
						'description': 'Clear Sky'
					},
					'wind_cdir'          : 'SSW',
					'wind_cdir_full'     : 'south-southwest',
					'wind_dir'           : 203,
					'wind_gust_spd'      : 6.7,
					'wind_spd'           : 3
				},
				{
					'app_max_temp'       : 26.7,
					'app_min_temp'       : 9,
					'clouds'             : 14,
					'clouds_hi'          : 22,
					'clouds_low'         : 0,
					'clouds_mid'         : 13,
					'datetime'           : '2024-11-18',
					'dewpt'              : 3.3,
					'high_temp'          : 27.9,
					'low_temp'           : 9.5,
					'max_dhi'            : null,
					'max_temp'           : 27.9,
					'min_temp'           : 9,
					'moon_phase'         : 0.83,
					'moon_phase_lunation': 0.59,
					'moonrise_ts'        : 1731981507,
					'moonset_ts'         : 1731933871,
					'ozone'              : 296,
					'pop'                : 0,
					'precip'             : 0,
					'pres'               : 980,
					'rh'                 : 52,
					'slp'                : 993,
					'snow'               : 0,
					'snow_depth'         : 0,
					'sunrise_ts'         : 1731922490,
					'sunset_ts'          : 1731972544,
					'temp'               : 16,
					'ts'                 : 1731898860,
					'uv'                 : 11,
					'valid_date'         : '2024-11-18',
					'vis'                : 24,
					'weather'            : {
						'code'       : 801,
						'icon'       : 'c02d',
						'description': 'Few clouds'
					},
					'wind_cdir'          : 'SSE',
					'wind_cdir_full'     : 'south-southeast',
					'wind_dir'           : 166,
					'wind_gust_spd'      : 2.7,
					'wind_spd'           : 2.1
				},
				{
					'app_max_temp'       : 25.4,
					'app_min_temp'       : 9.5,
					'clouds'             : 35,
					'clouds_hi'          : 29,
					'clouds_low'         : 0,
					'clouds_mid'         : 35,
					'datetime'           : '2024-11-19',
					'dewpt'              : 4.7,
					'high_temp'          : 26.1,
					'low_temp'           : 9.4,
					'max_dhi'            : null,
					'max_temp'           : 26.1,
					'min_temp'           : 9.5,
					'moon_phase'         : 0.74,
					'moon_phase_lunation': 0.62,
					'moonrise_ts'        : 1732071546,
					'moonset_ts'         : 1732024215,
					'ozone'              : 304,
					'pop'                : 0,
					'precip'             : 0,
					'pres'               : 976,
					'rh'                 : 54,
					'slp'                : 981,
					'snow'               : 0,
					'snow_depth'         : 0,
					'sunrise_ts'         : 1732008862,
					'sunset_ts'          : 1732058999,
					'temp'               : 16.8,
					'ts'                 : 1731985260,
					'uv'                 : 11,
					'valid_date'         : '2024-11-19',
					'vis'                : 24,
					'weather'            : {
						'code'       : 802,
						'icon'       : 'c02d',
						'description': 'Scattered clouds'
					},
					'wind_cdir'          : 'WSW',
					'wind_cdir_full'     : 'west-southwest',
					'wind_dir'           : 241,
					'wind_gust_spd'      : 2.3,
					'wind_spd'           : 2.4
				}
			],
			'lat'         : -33.5377,
			'lon'         : -71.5867,
			'state_code'  : '01',
			'timezone'    : 'America/Santiago'
		}

		const data = WeatherResponseSchema.safeParse( json )

		if ( !data.success ) {
			throw new Error( 'Invalid response' )
		}
		const weatherResponse						 = data.data
		const firstWeather                = weatherResponse.data[0]
		const restWeathers                = weatherResponse.data.slice( 1 )
		const forecast: WeatherForecast[] = restWeathers.map( ( weather ) => ( {
			temperature: weather.temp,
			date       : weather.valid_date,
			icon			 : weatherIconParser(weather.weather.code),
		} ) )
		const response: Weather           = {
			description:weatherDescriptionParser(firstWeather.weather.code),
			location   : weatherResponse.city_name,
			icon			 : weatherIconParser(firstWeather.weather.code),
			temperature: firstWeather.temp,
			forecast	 : forecast,
			info       : {
				uv            : firstWeather.uv,
				percentageRain: firstWeather.pop,
				aq           : 0
				// aq           : firstWeather.aqi
			}
		}
		return response
	}
}